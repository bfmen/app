import{c as y}from"./config.c00927f2.js";import D from"./list.7000cb68.js";import L from"./tagSelect.7868deb0.js";import{a as I}from"./axios.646f38c1.js";import{p as T}from"./pako.esm.f80f5d13.js";import{_ as O,r as h,o as V,c as B,h as c,w as b,g as P,p as z,k as K,f}from"./index.19fbe68c.2022_11_02_04_17_53.js";import"./index.2ceb81bb.js";function N(n){let e=n.toString();return n?T.ungzip(E(e),{to:"string"}):""}function U(n){typeof n!="string"&&(n=JSON.stringify(n));const e=T.gzip(n);return q(e)}const M={unzip:N,zip:U};function q(n){for(var e="",a=0;a<n.length;a++)e+=String.fromCharCode(n[a]);return e}function E(n){for(var e=[],a=0,t=n.length;a<t;++a)e.push(n.charCodeAt(a));var o=new Uint8Array(e);return o}class m{constructor(e,a,{onupgradeneeded:t,onversionchange:o=this._onversionchange}={}){this._name=e,this._version=a,this._onupgradeneeded=t,this._onversionchange=o,this._db=null}get db(){return this._db}async open(){if(!this._db)return this._db=await new Promise((e,a)=>{let t=!1;setTimeout(()=>{t=!0,a(new Error("The open request was blocked and timed out"))},this.OPEN_TIMEOUT);const o=indexedDB.open(this._name,this._version);o.onerror=()=>a(o.error),o.onupgradeneeded=i=>{t?(o.transaction.abort(),i.target.result.close()):this._onupgradeneeded&&this._onupgradeneeded(i)},o.onsuccess=({target:i})=>{const s=i.result;t?s.close():(s.onversionchange=this._onversionchange.bind(this),e(s))}}),this}async getKey(e,a){return(await this.getAllKeys(e,a,1))[0]}async getAll(e,a,t){return await this.getAllMatching(e,{query:a,count:t})}async getAllKeys(e,a,t){return(await this.getAllMatching(e,{query:a,count:t,includeKeys:!0})).map(({key:o})=>o)}async getAllMatching(e,{index:a,query:t=null,direction:o="next",count:i,includeKeys:s}={}){return await this.transaction([e],"readonly",(l,d)=>{const p=l.objectStore(e),g=a?p.index(a):p,r=[];g.openCursor(t,o).onsuccess=({target:k})=>{const _=k.result;if(_){const{primaryKey:A,key:C,value:w}=_;r.push(s?{primaryKey:A,key:C,value:w}:w),i&&r.length>=i?d(r):_.continue()}else d(r)}})}async transaction(e,a,t){return await this.open(),await new Promise((o,i)=>{const s=this._db.transaction(e,a);s.onabort=({target:l})=>i(l.error),s.oncomplete=()=>o(),t(s,l=>o(l))})}async _call(e,a,t,...o){const i=(s,l)=>{s.objectStore(a)[e](...o).onsuccess=({target:d})=>{l(d.result)}};return await this.transaction([a],t,i)}_onversionchange(){this.close()}close(){this._db&&(this._db.close(),this._db=null)}static async deleteDatabase(e){await new Promise((a,t)=>{const o=indexedDB.deleteDatabase(e);o.onerror=({target:i})=>{t(i.error)},o.onblocked=()=>{t(new Error("Delete blocked"))},o.onsuccess=()=>{a()}})}}m.prototype.OPEN_TIMEOUT=2e3;(function(){const n={readonly:["get","count","getKey","getAll","getAllKeys"],readwrite:["add","put","clear","delete"]};for(const[e,a]of Object.entries(n))for(const t of a)t in IDBObjectStore.prototype&&(m.prototype[t]=async function(o,...i){return await this._call(t,o,e,...i)})})();const{zip:ae,unzip:S}=M,u="b_dataSource",F={name:"keepAlive",components:{list:D,tagSelect:L},data(){return{isLoading:!1,current:1,vodid:"",dataSource:null,page:0,pageSize:20,list:[],timer:null,isLoad:!1,inputText:"",infiniteId:+new Date,db:null,value1:"vodid",value0:0,option2:[{text:"\u5012\u5E8F",value:0},{text:"\u6B63\u5E8F",value:1}]}},async created(){let n=weui.loading("loading");setTimeout(async()=>{try{let e=await J();window[u]=JSON.parse(S(e.data)),this.isLoad=!0,n.hide()}catch{n.hide(),setTimeout(()=>{this.loadAllData()},500)}})},computed:{option1(){let n=["vodid","createtime","updatetime","definition","commentcount","downcount_total","downnum","duration","scorenum","view_price","yearname","yearid"];return this.list.length&&Object.keys(this.list[0]).forEach(e=>{n.includes(e)||n.push(e)}),n.map(e=>({text:e,value:e}))}},watch:{page(){clearTimeout(this.timer),this.timer=setTimeout(()=>{console.log("load",this.page,this.value1,this.value0),this.list=this.getPageList(),this.page==1&&this.list.length&&(this.infiniteId=+new Date)},100)}},methods:{search(){console.log("search",this.inputText),this.inputText=="update"?weui.confirm("\u662F\u5426\u66F4\u65B0\u6E90\u6570\u636E",()=>{console.log("yes"),this.page=1,this.isLoading=!1,this.loadAllData(!0).then(()=>{this.infiniteId=+new Date,this.inputText=""})},()=>{console.log("no"),this.page=0,setTimeout(()=>{this.page=1},50)}):(this.page=0,setTimeout(()=>{this.page=1},50))},getPageList(){let n=window.b_dataSource;if(typeof n!="object")return[];let a=Object.keys(n).map(t=>n[t]).filter(t=>(t.coverpic=`${y.b_dataSource_url}/coverpic/${t.vodid}`,t.retcode_v=t.play_url_data?t.play_url_data.retcode:"99",this.inputText?(["vodid"].includes(this.value1)?[t.title,t[this.value1]]:[t[this.value1]]).some(o=>(o+"").toLowerCase().includes(this.inputText.toLowerCase())):!0)).sort((t,o)=>parseFloat(t[this.value1])==t[this.value1]&&parseFloat(o[this.value1])==o[this.value1]?this.value0==0?o[this.value1]-t[this.value1]:t[this.value1]-o[this.value1]:this.value0==0?o[this.value1].localeCompare(t[this.value1]):t[this.value1].localeCompare(o[this.value1])).slice(0,this.page*this.pageSize);return a.forEach(t=>{t.url=t.play_url_data?t.play_url_data.data.httpurl||t.play_url_data.data.httpurl_preview||t.play_url_data.retcode:""}),console.log("keys",a.map(t=>t[this.value1]).slice(0,this.pageSize)),a},async loadAllData(n){let e=weui.loading("downloading"),a=await I({url:["localhost","192.168"].some(o=>location.host.includes(o))&&!n?"./dataSource.txt":`${y.b_dataSource_url}/dataSource.txt`,onDownloadProgress:function(o){let i=j(o.loaded,2);console.log("progressEvent",i),e.querySelector(".weui-toast__content").innerText=i,o.lengthComputable;{let s=o.loaded/o.total*100;console.log("downLoadProgress",o.loaded,o.total,s)}}});await R(a.data);let t=JSON.parse(S(a.data));return window[u]=t,this.isLoad=!0,e.hide(),a},onRefresh(){this.page=1,this.isLoading=!1,setTimeout(()=>{this.infiniteId=+new Date})},infinite(n){this.page++;let e=this.list.length;setTimeout(()=>{e==this.list.length?(n.complete(),this.$toast("\u52A0\u8F7D\u5B8C\u6210")):n.loaded()},1e3)}}};function J(){var n=x();return n.get(u,u)}function R(n){var e=x();return e.put(u,{id:u,data:n})}function x(){var n=new m(u,1,{onupgradeneeded:e=>{console.log("onupgradeneeded");let a=e.target.result,t=u;a.objectStoreNames.contains(t)||a.createObjectStore(t,{keyPath:"id"})},onversionchange:e=>{}});return n}function j(n,e,a){var t;for(a=a||["B","K","M","G","TB"];(t=a.shift())&&n>1024;)n=n/1024;return(t==="B"?n:n.toFixed(e===void 0?2:e))+t}const v=n=>(z("data-v-7e4b7199"),n=n(),K(),n),W={key:0,class:"hot"},G=v(()=>f("div",{slot:"spinner"},"Loading...",-1)),H=v(()=>f("div",{slot:"no-more"},"No more message",-1)),Q=v(()=>f("div",{slot:"no-results"},"No results message",-1));function X(n,e,a,t,o,i){const s=h("van-dropdown-item"),l=h("van-dropdown-menu"),d=h("van-search"),p=h("list"),g=h("infinite-loading");return o.isLoad?(V(),B("div",W,[c(l,null,{default:b(()=>[c(s,{modelValue:o.value1,"onUpdate:modelValue":e[0]||(e[0]=r=>o.value1=r),options:i.option1,onChange:i.search},null,8,["modelValue","options","onChange"]),c(s,{modelValue:o.value0,"onUpdate:modelValue":e[1]||(e[1]=r=>o.value0=r),options:o.option2,onChange:i.search},null,8,["modelValue","options","onChange"])]),_:1}),c(d,{modelValue:o.inputText,"onUpdate:modelValue":e[2]||(e[2]=r=>o.inputText=r),placeholder:"\u8BF7\u8F93\u5165\u641C\u7D22\u5173\u952E\u8BCD",onSearch:i.search},null,8,["modelValue","onSearch"]),c(p,{dataList:o.list,showKey:o.value1},null,8,["dataList","showKey"]),c(g,{onInfinite:i.infinite,identifier:o.infiniteId,ref:"infiniteLoading"},{default:b(()=>[G,H,Q]),_:1},8,["onInfinite","identifier"])])):P("",!0)}const ie=O(F,[["render",X],["__scopeId","data-v-7e4b7199"]]);export{ie as default};
